name: CI - Secure Train Pipeline
# Required status checks to enforce in branch protection:
# - Security Gates (Pre-commit, Gitleaks, SCA, SAST)
# - Test Gates
# - DVC Stage Pipeline (Fail Fast)

on:
  push:
    branches:
      - "**"
  pull_request:
    branches:
      - "**"

concurrency:
  group: ci-train-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

defaults:
  run:
    shell: bash

jobs:
  security-gates:
    name: Security Gates (Pre-commit, Gitleaks, SCA, SAST)
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
          cache-dependency-path: requirements.txt

      - name: Install Security Tooling
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pip-audit semgrep pre-commit

      - name: Run Pre-commit Hooks
        run: pre-commit run --all-files --show-diff-on-failure

      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Run SCA (pip-audit)
        run: pip-audit -r requirements.txt --strict

      - name: Run SAST (Semgrep)
        run: semgrep scan --config auto --error --metrics=off

      - name: Dependency Review (PR only)
        if: ${{ github.event_name == 'pull_request' }}
        uses: actions/dependency-review-action@v4

  test-gates:
    name: Test Gates
    runs-on: ubuntu-latest
    needs: security-gates
    permissions:
      contents: read
    env:
      PYTHONPATH: .
      APP_ENV: dev
      APP_SKIP_MODEL_LOAD: "true"

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          persist-credentials: false

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
          cache-dependency-path: requirements.txt

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run Unit Tests
        run: pytest -q tests/unit

      - name: Run Integration Tests
        run: pytest -q tests/integration

      - name: Run Smoke Tests
        run: pytest -q tests/smoke

      - name: Run Performance Tests
        run: pytest -q tests/performance

  train-pipeline:
    name: DVC Stage Pipeline (Fail Fast)
    runs-on: ubuntu-latest
    needs: test-gates
    permissions:
      contents: read
      id-token: write
    env:
      APP_ENV: dev
      PYTHONPATH: .

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          persist-credentials: false

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
          cache-dependency-path: requirements.txt

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install "dvc[s3]"

      - name: Enforce OIDC Role on Push
        if: ${{ github.event_name == 'push' && secrets.AWS_ROLE_TO_ASSUME == '' }}
        run: |
          echo "AWS_ROLE_TO_ASSUME secret is required for OIDC-based pipeline access."
          exit 1

      - name: Configure AWS Credentials via OIDC
        if: ${{ secrets.AWS_ROLE_TO_ASSUME != '' }}
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ vars.AWS_REGION || 'us-east-1' }}

      - name: Run Full DVC Pipeline
        run: dvc repro
